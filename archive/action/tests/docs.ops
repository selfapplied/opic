;;; docs.ops â€” Auto-generate documentation from test voices

;; Tests seed their own documentation - the system writes its own READMEs
;; Each test voice becomes a documentation entry

;; Generate documentation from test directory
voice test.generate_docs / {
  tests.discover ->
  test.extract_voices ->
  test.generate_readme ->
  documentation
}

;; Extract voices from test files
voice test.extract_voices / {
  test_files ->
  test.parse_each ->
  test.collect_voices ->
  test_voices
}

;; Generate README from test voices
voice test.generate_readme / {
  test_voices ->
  test.organize_by_category ->
  test.format_sections ->
  test.add_examples ->
  readme_content
}

;; Organize tests by category
voice test.organize_by_category / {
  voices ->
  test.detect_category ->
  test.group_by_category ->
  categorized_tests
}

;; Detect test category from voice name
voice test.detect_category / {
  voice_name ->
  test.check_prefix ->
  category
}

;; Check prefix patterns
voice test.check_prefix / {
  name ->
  starts_with "atomic" -> "Atomic" ->
  starts_with "compositional" -> "Compositional" ->
  starts_with "progressive" -> "Progressive" ->
  starts_with "coherence" -> "Coherence" ->
  starts_with "context" -> "Context-Aware" ->
  starts_with "field" -> "Field-Based" ->
  starts_with "intelligence" -> "Intelligence" ->
  starts_with "complex" -> "Complex" ->
  starts_with "validation" -> "Validation" ->
  "Other"
}

;; Format documentation sections
voice test.format_sections / {
  categorized ->
  test.format_header ->
  test.format_category_section ->
  test.format_examples ->
  formatted_docs
}

;; Format category section
voice test.format_category_section / {
  category + tests ->
  test.format_category_header ->
  test.format_test_list ->
  section_content
}

;; Format test list
voice test.format_test_list / {
  tests ->
  test.format_each_test ->
  test_list
}

;; Format individual test entry
voice test.format_each_test / {
  test_voice ->
  test.extract_description ->
  test.format_entry ->
  formatted_entry
}

;; Extract description from voice
voice test.extract_description / {
  voice_body ->
  test.parse_chain ->
  test.find_description ->
  description
}

;; Generate full README
voice test.generate_readme_full / {
  tests.discover ->
  test.generate_docs ->
  test.add_intro ->
  test.add_usage ->
  test.add_examples ->
  complete_readme
}

;; Add introduction section
voice test.add_intro / {
  docs ->
  "## OPIC Test Suite" ->
  "" ->
  "This directory contains OPIC test files that validate system behavior." ->
  "Tests naturally discover themselves - no hardcoding needed." ->
  "" ->
  intro_section
}

;; Add usage section
voice test.add_usage / {
  docs ->
  "## Usage" ->
  "" ->
  "Run all tests: `make test`" ->
  "Run specific test: `opic action/tests/<test_name>.ops`" ->
  "" ->
  usage_section
}

;; Add examples section
voice test.add_examples / {
  docs ->
  "## Examples" ->
  "" ->
  test.extract_examples ->
  examples_section
}

target docs / "auto_documentation_generator"
voice main / {test.generate_readme_full -> docs}

