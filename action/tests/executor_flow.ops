;;; test_executor_flow.ops â€” Test executor flow: file discovery, file-output association, comment learning

include core/bootstrap.ops

;; Test definitions
def test_result { name, passed, message }

;; Test 1: File discovery (natural discovery - no hardcoded paths)
voice test.file_discovery / {
  project_root -> 
  opic.discover_files "tests" -> 
  opic.discover_files "systems" -> 
  opic.discover_files "core" -> 
  test.files_found
}

voice opic.discover_files / {
  directory + project_root -> 
  opic.glob_pattern -> 
  opic.find_ops_files -> 
  files_found
}

voice opic.glob_pattern / {
  directory -> 
  directory + "/*.ops" -> 
  pattern
}

voice opic.find_ops_files / {
  pattern + project_root -> 
  file.find_matching -> 
  ops_files
}

voice test.files_found / {
  files -> 
  if_empty "No test files found" -> 
  if_found test.load_file -> 
  test_result
}

voice test.load_file / {
  file + executor -> 
  opic.load_ops_file -> 
  "Discovered and loaded file via natural discovery" -> 
  test_result
}

;; Test 2: File-output association
voice test.file_output_association / {
  file + executor -> 
  executor.execute_voice "main" -> 
  executor.associate_file_output -> 
  executor.get_file_output_pairs -> 
  test.check_pairs -> 
  test_result
}

voice executor.associate_file_output / {
  file + output -> 
  opic.record_association -> 
  associated
}

voice executor.get_file_output_pairs / {
  opic.get_associations -> 
  pairs
}

voice test.check_pairs / {
  pairs -> 
  if_empty "No file-output pairs recorded" -> 
  if_found "Associated files with output" -> 
  test_result
}

;; Test 3: Comment learning
voice test.comment_learning / {
  file + executor -> 
  opic.extract_comments -> 
  opic.learn_from_comments -> 
  test.check_comments -> 
  test_result
}

voice opic.extract_comments / {
  file -> 
  opic.read_file -> 
  opic.find_comment_lines -> 
  comments
}

voice opic.find_comment_lines / {
  content -> 
  opic.split_lines -> 
  opic.filter_comments -> 
  comment_lines
}

voice opic.filter_comments / {
  lines -> 
  opic.check_starts_with ";" -> 
  comment_lines
}

voice opic.learn_from_comments / {
  comments -> 
  opic.extract_concepts -> 
  opic.store_learned -> 
  learned
}

voice test.check_comments / {
  learned -> 
  if_empty "No comments extracted" -> 
  if_found "Extracted comments and learned from them" -> 
  test_result
}

;; Test 4: Code-output learning integration
voice test.code_output_learning / {
  executor -> 
  opic.check_code_output_learner -> 
  test.check_learner_available -> 
  test_result
}

voice opic.check_code_output_learner / {
  executor -> 
  opic.has_primitive "code_output_learner" -> 
  learner_available
}

voice test.check_learner_available / {
  available -> 
  if_true "CodeOutputLearner available" -> 
  if_false "CodeOutputLearner not available" -> 
  test_result
}

;; Test 5: Comment-code coupling integration
voice test.comment_code_coupling / {
  executor -> 
  opic.check_comment_code_coupler -> 
  opic.extract_comment_code_pairs -> 
  test.check_pairs_extracted -> 
  test_result
}

voice opic.check_comment_code_coupler / {
  executor -> 
  opic.has_primitive "comment_code_coupler" -> 
  coupler_available
}

voice opic.extract_comment_code_pairs / {
  file + coupler -> 
  opic.extract_pairs -> 
  pairs
}

voice test.check_pairs_extracted / {
  pairs -> 
  if_empty "No comment-code pairs extracted" -> 
  if_found "Comment-code pairs extracted" -> 
  test_result
}

;; Test suite: run all tests
voice test.suite / {
  test.file_discovery -> 
  test.file_output_association -> 
  test.comment_learning -> 
  test.code_output_learning -> 
  test.comment_code_coupling -> 
  test.results
}

voice test.results / {
  results -> 
  test.collect_passed -> 
  test.collect_failed -> 
  test.report -> 
  test_summary
}

voice test.collect_passed / {
  results -> 
  opic.filter_passed -> 
  passed_count
}

voice test.collect_failed / {
  results -> 
  opic.filter_failed -> 
  failed_count
}

voice test.report / {
  passed + failed -> 
  opic.format_summary -> 
  report
}

target test_executor_flow / "executor_flow_tests"
voice main / {test.suite -> test.results -> test_executor_flow}

