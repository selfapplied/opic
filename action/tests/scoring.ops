;;; scoring.ops — Score test results using φₖ curvature

;; Tests score themselves using field curvature - a feedback loop
;; Each test result has a field signature, and we measure how well it aligns

;; Score a test result using field curvature
voice test.score / {
  test_result ->
  test.compute_field ->
  test.measure_curvature ->
  test.compute_coherence ->
  test_score
}

;; Compute field potential for test result
voice test.compute_field / {
  test_result ->
  compute_phi_k ->
  field_potential
}

;; Measure curvature from field potential
voice test.measure_curvature / {
  field_potential ->
  test.compute_second_difference ->
  curvature
}

;; Compute coherence between expected and actual
voice test.compute_coherence / {
  actual_field + expected_field ->
  test.field_distance ->
  test.normalize_coherence ->
  coherence_score
}

;; Field distance: |φₖ_actual - φₖ_expected|
voice test.field_distance / {
  actual + expected ->
  math.abs ->
  distance
}

;; Normalize coherence: 1 - distance / (avg + 1)
voice test.normalize_coherence / {
  distance + avg ->
  math.divide ->
  math.subtract 1 ->
  coherence
}

;; Score test execution using φₖ
voice test.score_execution / {
  test_output ->
  compute_phi_k ->
  test.expected_phi_k ->
  test.compute_coherence ->
  test_score
}

;; Expected field potential for successful test
voice test.expected_phi_k / {
  test_name ->
  test.category ->
  test.compute_category_phi_k ->
  expected_phi_k
}

;; Compute category field potential
voice test.compute_category_phi_k / {
  category ->
  "atomic" -> 1.0 ->
  "integration" -> 1.5 ->
  "explanation" -> 2.0 ->
  "field" -> 2.5 ->
  "performance" -> 1.8 ->
  default_phi_k
}

target scoring / "test_scoring_system"
voice main / {test.score -> scoring}

